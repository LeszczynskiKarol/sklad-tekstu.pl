---
import BaseLayout from '../../layouts/BaseLayout.astro';

const contactSchema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "ContactPage",
      "@id": "https://www.sklad-tekstu.pl/kontakt/#page",
      "name": "Kontakt ‚Äî sklad-tekstu.pl",
      "description": "Wy≈õlij tekst do wyceny sk≈Çadu LaTeX. Bezp≈Çatna wycena w 24 godz.",
      "url": "https://www.sklad-tekstu.pl/kontakt/",
      "isPartOf": { "@id": "https://www.sklad-tekstu.pl/#website" }
    },
    {
      "@type": "ProfessionalService",
      "@id": "https://www.sklad-tekstu.pl/#organization",
      "name": "sklad-tekstu.pl",
      "email": "kontakt@sklad-tekstu.pl",
      "url": "https://www.sklad-tekstu.pl"
    }
  ]
};

const serviceOptions = [
  'Podrƒôczniki i skrypty',
  'Prace naukowe',
  'ƒÜwiczenia i arkusze',
  'Raporty i dokumentacja',
  'Katalogi i broszury',
  'Instrukcje i procedury',
  'Prezentacje i postery',
  'E-booki i publikacje cyfrowe',
  'Inne / Nie wiem jeszcze'
];
---

<BaseLayout
  title="Kontakt ‚Äî Wy≈õlij tekst do wyceny sk≈Çadu LaTeX"
  description="Wy≈õlij tekst do bezp≈Çatnej wyceny sk≈Çadu LaTeX. Przyjmujemy Word, PDF, Markdown, pliki .tex. Wycena w 24 godzin, bez zobowiƒÖza≈Ñ."
  keywords="wycena sk≈Çad tekstu, kontakt sklad-tekstu, wycena latex, formularz kontaktowy, sk≈Çad dokument√≥w wycena"
  schema={contactSchema}
>

  <section class="contact" aria-labelledby="contact-title">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="contact__breadcrumb" aria-label="≈öcie≈ºka nawigacji">
        <a href="/">Strona g≈Ç√≥wna</a> <span aria-hidden="true">‚Ä∫</span>
        <span>Kontakt</span>
      </nav>

      <div class="contact__header">
        <div class="contact__env" aria-hidden="true" set:html="\\begin{wycena}" />
        <div class="contact__rule-top" aria-hidden="true"></div>
        <h1 id="contact-title">Wy≈õlij tekst ‚Äî wycenimy w&nbsp;24 godz.</h1>
        <p class="contact__subtitle">
          Przyjmujemy pliki Word, PDF, Markdown, LaTeX, tekst surowy i&nbsp;dowolne
          inne formaty. Wycena jest bezp≈Çatna i&nbsp;niezobowiƒÖzujƒÖca.
        </p>
        <div class="contact__rule-bottom" aria-hidden="true"></div>
      </div>

      <div class="contact__grid">
        <!-- FORM -->
        <div class="contact__form-wrap">
          <form id="contact-form" class="form" novalidate>
            <!-- Name -->
            <div class="form__group">
              <label for="field-name" class="form__label">Imiƒô i nazwisko <span class="form__req">*</span></label>
              <input type="text" id="field-name" name="name" class="form__input" required autocomplete="name" placeholder="Jan Kowalski">
              <span class="form__error" id="error-name"></span>
            </div>

            <!-- Email -->
            <div class="form__group">
              <label for="field-email" class="form__label">Adres email <span class="form__req">*</span></label>
              <input type="email" id="field-email" name="email" class="form__input" required autocomplete="email" placeholder="jan@uczelnia.pl">
              <span class="form__error" id="error-email"></span>
            </div>

            <!-- Phone + Company row -->
            <div class="form__row">
              <div class="form__group">
                <label for="field-phone" class="form__label">Telefon</label>
                <input type="tel" id="field-phone" name="phone" class="form__input" autocomplete="tel" placeholder="+48 ...">
              </div>
              <div class="form__group">
                <label for="field-company" class="form__label">Uczelnia / Firma</label>
                <input type="text" id="field-company" name="company" class="form__input" autocomplete="organization" placeholder="Nazwa instytucji">
              </div>
            </div>

            <!-- Service + Pages row -->
            <div class="form__row">
              <div class="form__group">
                <label for="field-service" class="form__label">Rodzaj us≈Çugi</label>
                <select id="field-service" name="service" class="form__input form__select">
                  <option value="">‚Äî wybierz ‚Äî</option>
                  {serviceOptions.map((s) => (
                    <option value={s}>{s}</option>
                  ))}
                </select>
              </div>
              <div class="form__group">
                <label for="field-pages" class="form__label">Objƒôto≈õƒá (str.)</label>
                <input type="text" id="field-pages" name="pages" class="form__input" placeholder="np. ~200 stron">
              </div>
            </div>

            <!-- Message -->
            <div class="form__group">
              <label for="field-message" class="form__label">Opis projektu <span class="form__req">*</span></label>
              <textarea id="field-message" name="message" class="form__input form__textarea" required rows="6" placeholder="Opisz dokument, wymagania, po≈ºƒÖdany format wyj≈õciowy, termin realizacji..."></textarea>
              <span class="form__error" id="error-message"></span>
            </div>

            <!-- File upload -->
            <div class="form__group">
              <label class="form__label">Za≈ÇƒÖczniki <span class="form__optional">(opcjonalnie, maks. 10 MB / plik)</span></label>
              <div class="upload" id="upload-zone">
                <div class="upload__content">
                  <div class="upload__icon" aria-hidden="true">üìé</div>
                  <p class="upload__text">PrzeciƒÖgnij pliki tutaj lub <button type="button" class="upload__browse" id="upload-browse">wybierz z dysku</button></p>
                  <p class="upload__hint">.pdf .doc .docx .tex .bib .jpg .png .zip .xlsx .csv .txt .rtf .md .odt</p>
                </div>
                <input type="file" id="upload-input" multiple accept=".pdf,.doc,.docx,.tex,.bib,.sty,.cls,.jpg,.jpeg,.png,.tiff,.eps,.svg,.zip,.rar,.7z,.xlsx,.csv,.txt,.rtf,.odt,.md" hidden>
              </div>
              <div class="upload__list" id="upload-list"></div>
            </div>

            <!-- Submit -->
            <button type="submit" class="form__submit" id="submit-btn">
              <span class="form__submit-text">Wy≈õlij zapytanie</span>
              <span class="form__submit-arrow">‚Üí</span>
              <span class="form__submit-loading" id="submit-loading" hidden>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="0.8s" repeatCount="indefinite"/></circle></svg>
              </span>
            </button>
          </form>

          <!-- Success -->
          <div class="form__success" id="form-success" hidden>
            <div class="form__success-icon">‚úì</div>
            <h3>Wiadomo≈õƒá wys≈Çana</h3>
            <p>Dziƒôkujemy za kontakt. Odpowiemy w&nbsp;ciƒÖgu 24&nbsp;godzin z&nbsp;wycenƒÖ i&nbsp;harmonogramem prac.</p>
            <div class="form__success-env" aria-hidden="true" set:html="\\end{wycena}" />
          </div>

          <!-- Error -->
          <div class="form__global-error" id="form-error" hidden>
            <p>WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania. Spr√≥buj ponownie lub napisz bezpo≈õrednio na <a href="mailto:kontakt@sklad-tekstu.pl">kontakt@sklad-tekstu.pl</a>.</p>
          </div>
        </div>

        <!-- SIDEBAR -->
        <aside class="contact__sidebar">
          <div class="contact__sidebar-block">
            <span class="contact__sidebar-label">Email</span>
            <a href="mailto:kontakt@sklad-tekstu.pl" class="contact__sidebar-value">kontakt@sklad-tekstu.pl</a>
          </div>
          <div class="contact__sidebar-block">
            <span class="contact__sidebar-label">Czas odpowiedzi</span>
            <span class="contact__sidebar-value">do 24 godzin</span>
          </div>
          <div class="contact__sidebar-block">
            <span class="contact__sidebar-label">Wycena</span>
            <span class="contact__sidebar-value">bezp≈Çatna</span>
          </div>
          <div class="contact__sidebar-block">
            <span class="contact__sidebar-label">Przyjmujemy formaty</span>
            <div class="contact__sidebar-formats">
              <span>.tex</span><span>.doc</span><span>.docx</span><span>.pdf</span>
              <span>.md</span><span>.txt</span><span>.rtf</span><span>.odt</span>
              <span>.bib</span><span>.zip</span>
            </div>
          </div>
          <div class="contact__sidebar-note">
            <p>Je≈õli masz gotowe pliki .tex ‚Äî ≈õwietnie! Je≈õli nie ‚Äî przyjmiemy tekst w&nbsp;dowolnym formacie i&nbsp;sami przygotujemy kompletny projekt w&nbsp;LaTeX.</p>
          </div>
        </aside>
      </div>

      <div class="contact__footer-env" aria-hidden="true" set:html="\\end{wycena}" />
    </div>
  </section>

</BaseLayout>

<style>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê‚ïê‚ïê */
  .contact {
    padding: var(--space-24) 0 var(--space-20);
  }

  .contact__breadcrumb {
    display: flex;
    gap: var(--space-2);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--ink-faint);
    margin-bottom: var(--space-10);
  }

  .contact__breadcrumb a {
    color: var(--ink-faint);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .contact__breadcrumb a:hover { color: var(--accent); }

  .contact__header {
    text-align: center;
    max-width: 600px;
    margin: 0 auto var(--space-12);
  }

  .contact__env {
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--ink-faint);
    letter-spacing: 0.06em;
    margin-bottom: var(--space-4);
  }

  .contact__rule-top {
    width: 100%;
    height: 2.5px;
    background: var(--ink);
    margin-bottom: var(--space-6);
  }

  .contact__rule-bottom {
    width: 100%;
    height: 1px;
    background: var(--ink);
    margin-top: var(--space-4);
  }

  .contact__header h1 {
    font-family: var(--font-display);
    font-size: clamp(1.6rem, 3.5vw, 2.2rem);
    font-weight: var(--fw-bold);
    color: var(--ink);
    line-height: var(--lh-tight);
    margin-bottom: var(--space-3);
  }

  .contact__subtitle {
    font-family: var(--font-serif);
    font-size: var(--fs-base);
    font-style: italic;
    color: var(--ink-light);
    line-height: var(--lh-relaxed);
  }

  .contact__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-12);
  }

  @media (min-width: 860px) {
    .contact__grid {
      grid-template-columns: 1fr 260px;
    }
  }

  .contact__footer-env {
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--ink-faint);
    letter-spacing: 0.06em;
    text-align: center;
    margin-top: var(--space-12);
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê FORM ‚ïê‚ïê‚ïê‚ïê‚ïê */
  .form__group {
    margin-bottom: var(--space-5);
  }

  .form__row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-5);
  }

  @media (max-width: 600px) {
    .form__row { grid-template-columns: 1fr; }
  }

  .form__label {
    display: block;
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-bottom: var(--space-2);
  }

  .form__req { color: var(--accent); }

  .form__optional {
    text-transform: none;
    letter-spacing: 0;
    color: var(--ink-faint);
    font-size: 0.62rem;
  }

  .form__input {
    width: 100%;
    padding: 0.7rem 0.9rem;
    font-family: var(--font-serif);
    font-size: var(--fs-base);
    color: var(--ink);
    background: var(--white);
    border: 1px solid var(--rule);
    border-radius: 0;
    outline: none;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    -webkit-appearance: none;
    appearance: none;
  }

  .form__input:focus {
    border-color: var(--ink);
    box-shadow: 0 0 0 1px var(--ink);
  }

  .form__input::placeholder {
    color: var(--rule);
    font-style: italic;
  }

  .form__input.error {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent);
  }

  .form__select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpolyline points='0,0 5,6 10,0' fill='none' stroke='%239e968d' stroke-width='1.5'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.9rem center;
    padding-right: 2.5rem;
  }

  .form__textarea {
    resize: vertical;
    min-height: 140px;
    line-height: var(--lh-relaxed);
  }

  .form__error {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.62rem;
    color: var(--accent);
    margin-top: var(--space-1);
    min-height: 1em;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê UPLOAD ‚ïê‚ïê‚ïê‚ïê‚ïê */
  .upload {
    border: 1.5px dashed var(--rule);
    padding: var(--space-6);
    text-align: center;
    transition: all var(--transition-fast);
    cursor: pointer;
    background: var(--paper);
  }

  .upload:hover,
  .upload.dragover {
    border-color: var(--accent);
    background: var(--accent-bg);
  }

  .upload__icon {
    font-size: 1.4rem;
    margin-bottom: var(--space-2);
  }

  .upload__text {
    font-family: var(--font-serif);
    font-size: var(--fs-sm);
    color: var(--ink-muted);
    margin: 0;
  }

  .upload__browse {
    background: none;
    border: none;
    font-family: var(--font-serif);
    font-size: var(--fs-sm);
    color: var(--accent);
    text-decoration: underline;
    cursor: pointer;
    padding: 0;
  }

  .upload__browse:hover { color: var(--accent-hover); }

  .upload__hint {
    font-family: var(--font-mono);
    font-size: 0.58rem;
    color: var(--ink-faint);
    margin: var(--space-2) 0 0;
    letter-spacing: 0.03em;
  }

  .upload__list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-top: var(--space-3);
  }

  .upload__file {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    background: var(--paper-warm);
    border: 0.5px solid var(--rule-light);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--ink-muted);
  }

  .upload__file-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .upload__file-size {
    color: var(--ink-faint);
    font-size: 0.6rem;
    flex-shrink: 0;
  }

  .upload__file-status {
    flex-shrink: 0;
    font-size: 0.6rem;
  }

  .upload__file-status.uploading { color: var(--latex-blue); }
  .upload__file-status.done { color: var(--success); }
  .upload__file-status.failed { color: var(--accent); }

  .upload__file-remove {
    background: none;
    border: none;
    font-size: 0.7rem;
    color: var(--ink-faint);
    cursor: pointer;
    padding: 0 2px;
    line-height: 1;
    flex-shrink: 0;
    transition: color var(--transition-fast);
  }

  .upload__file-remove:hover { color: var(--accent); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê SUBMIT ‚ïê‚ïê‚ïê‚ïê‚ïê */
  .form__submit {
    display: inline-flex;
    align-items: center;
    gap: 0.7rem;
    padding: 0.9rem 2.2rem;
    background: var(--ink);
    color: var(--paper);
    font-family: var(--font-serif);
    font-size: var(--fs-base);
    border: none;
    border-radius: 0;
    cursor: pointer;
    transition: all var(--transition-base);
    margin-top: var(--space-2);
  }

  .form__submit:hover:not(:disabled) {
    background: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(139, 26, 26, 0.2);
  }

  .form__submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .form__submit-arrow {
    transition: transform var(--transition-fast);
  }

  .form__submit:hover:not(:disabled) .form__submit-arrow {
    transform: translateX(4px);
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê SUCCESS / ERROR ‚ïê‚ïê‚ïê‚ïê‚ïê */
  .form__success {
    text-align: center;
    padding: var(--space-12) 0;
  }

  .form__success-icon {
    width: 56px;
    height: 56px;
    border: 2px solid var(--success);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-4);
    font-size: 1.4rem;
    color: var(--success);
  }

  .form__success h3 {
    font-family: var(--font-display);
    font-size: var(--fs-xl);
    font-weight: var(--fw-semibold);
    margin-bottom: var(--space-2);
  }

  .form__success p {
    font-family: var(--font-serif);
    font-size: var(--fs-base);
    color: var(--ink-light);
    line-height: var(--lh-relaxed);
    max-width: 400px;
    margin: 0 auto;
  }

  .form__success-env {
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--ink-faint);
    margin-top: var(--space-6);
  }

  .form__global-error {
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: rgba(139, 26, 26, 0.05);
    border-left: 3px solid var(--accent);
  }

  .form__global-error p {
    font-family: var(--font-serif);
    font-size: var(--fs-sm);
    color: var(--ink-light);
    margin: 0;
  }

  .form__global-error a {
    color: var(--accent);
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê */
  .contact__sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  @media (min-width: 860px) {
    .contact__sidebar {
      position: sticky;
      top: calc(60px + var(--space-6));
      align-self: start;
    }
  }

  .contact__sidebar-block {
    padding-bottom: var(--space-4);
    border-bottom: 0.5px solid var(--rule-light);
  }

  .contact__sidebar-label {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: var(--space-1);
  }

  .contact__sidebar-value {
    font-family: var(--font-serif);
    font-size: var(--fs-sm);
    color: var(--ink);
    text-decoration: none;
  }

  a.contact__sidebar-value {
    color: var(--accent);
    transition: color var(--transition-fast);
  }

  a.contact__sidebar-value:hover {
    color: var(--accent-hover);
  }

  .contact__sidebar-formats {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    margin-top: var(--space-1);
  }

  .contact__sidebar-formats span {
    font-family: var(--font-mono);
    font-size: 0.58rem;
    padding: 0.15rem 0.45rem;
    background: var(--accent-bg);
    color: var(--accent);
    letter-spacing: 0.02em;
  }

  .contact__sidebar-note {
    padding: var(--space-4);
    background: var(--paper-warm);
    border-left: 2px solid var(--rule);
  }

  .contact__sidebar-note p {
    font-family: var(--font-serif);
    font-size: var(--fs-sm);
    font-style: italic;
    color: var(--ink-muted);
    line-height: var(--lh-relaxed);
    margin: 0;
  }
</style>

<script define:vars={{ }}>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CONTACT FORM ‚Äî Client-side logic
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // ‚ö†Ô∏è ZMIE≈É PO URUCHOMIENIU setup-aws.sh:
  const API_URL = 'https://ghil2rhvq8.execute-api.eu-north-1.amazonaws.com';

  const MAX_FILE_SIZE = 10 * 1024 * 1024;
  const MAX_FILES = 5;

  let uploadedFiles = []; // { name, key, size, status }

  function initContactForm() {
    const form = document.getElementById('contact-form');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = form?.querySelector('.form__submit-text');
    const submitArrow = form?.querySelector('.form__submit-arrow');
    const submitLoading = document.getElementById('submit-loading');
    const successEl = document.getElementById('form-success');
    const errorEl = document.getElementById('form-error');
    const uploadZone = document.getElementById('upload-zone');
    const uploadInput = document.getElementById('upload-input');
    const uploadBrowse = document.getElementById('upload-browse');
    const uploadList = document.getElementById('upload-list');

    if (!form) return;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê UPLOAD ‚ïê‚ïê‚ïê‚ïê‚ïê
    uploadBrowse?.addEventListener('click', () => uploadInput?.click());
    
    uploadZone?.addEventListener('click', (e) => {
      if (e.target === uploadBrowse) return;
      uploadInput?.click();
    });

    uploadZone?.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone?.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone?.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer?.files) {
        handleFiles(Array.from(e.dataTransfer.files));
      }
    });

    uploadInput?.addEventListener('change', () => {
      if (uploadInput.files) {
        handleFiles(Array.from(uploadInput.files));
        uploadInput.value = '';
      }
    });

    function handleFiles(files) {
      for (const file of files) {
        if (uploadedFiles.length >= MAX_FILES) {
          alert(`Maksymalnie ${MAX_FILES} plik√≥w.`);
          break;
        }
        if (file.size > MAX_FILE_SIZE) {
          alert(`Plik "${file.name}" jest za du≈ºy (maks. 10 MB).`);
          continue;
        }
        uploadFile(file);
      }
    }

    async function uploadFile(file) {
      const fileEntry = {
        name: file.name,
        size: file.size,
        key: null,
        status: 'uploading'
      };
      uploadedFiles.push(fileEntry);
      renderFileList();

      try {
        // 1. Get presigned URL
        const presignRes = await fetch(`${API_URL}/presign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: file.name,
            contentType: file.type || 'application/octet-stream',
            size: file.size
          })
        });

        if (!presignRes.ok) {
          const err = await presignRes.json().catch(() => ({}));
          throw new Error(err.error || 'B≈ÇƒÖd presign');
        }

        const { uploadUrl, key } = await presignRes.json();

        // 2. Upload to S3
        const uploadRes = await fetch(uploadUrl, {
          method: 'PUT',
          headers: { 'Content-Type': file.type || 'application/octet-stream' },
          body: file
        });

        if (!uploadRes.ok) throw new Error('Upload failed');

        fileEntry.key = key;
        fileEntry.status = 'done';
      } catch (err) {
        console.error('Upload error:', err);
        fileEntry.status = 'failed';
      }

      renderFileList();
    }

    function renderFileList() {
      if (!uploadList) return;
      uploadList.innerHTML = uploadedFiles.map((f, i) => `
        <div class="upload__file">
          <span class="upload__file-name">${escapeHtml(f.name)}</span>
          <span class="upload__file-size">${formatSize(f.size)}</span>
          <span class="upload__file-status ${f.status}">
            ${f.status === 'uploading' ? '‚è≥' : f.status === 'done' ? '‚úì' : '‚úï'}
          </span>
          <button type="button" class="upload__file-remove" data-index="${i}" aria-label="Usu≈Ñ plik">√ó</button>
        </div>
      `).join('');

      uploadList.querySelectorAll('.upload__file-remove').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index);
          uploadedFiles.splice(idx, 1);
          renderFileList();
        });
      });
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê VALIDATION ‚ïê‚ïê‚ïê‚ïê‚ïê
    function validate() {
      let valid = true;

      const name = form.querySelector('#field-name');
      const email = form.querySelector('#field-email');
      const message = form.querySelector('#field-message');

      // Reset
      [name, email, message].forEach(el => el?.classList.remove('error'));
      form.querySelectorAll('.form__error').forEach(el => el.textContent = '');

      if (!name?.value.trim()) {
        name?.classList.add('error');
        document.getElementById('error-name').textContent = 'Pole wymagane';
        valid = false;
      }

      if (!email?.value.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
        email?.classList.add('error');
        document.getElementById('error-email').textContent = 'Podaj prawid≈Çowy adres email';
        valid = false;
      }

      if (!message?.value.trim()) {
        message?.classList.add('error');
        document.getElementById('error-message').textContent = 'Opisz sw√≥j projekt';
        valid = false;
      }

      return valid;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê SUBMIT ‚ïê‚ïê‚ïê‚ïê‚ïê
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorEl.hidden = true;

      if (!validate()) return;

      // Check if any uploads still in progress
      if (uploadedFiles.some(f => f.status === 'uploading')) {
        alert('Poczekaj na zako≈Ñczenie uploadu plik√≥w.');
        return;
      }

      // Disable
      submitBtn.disabled = true;
      if (submitText) submitText.textContent = 'Wysy≈Çanie...';
      if (submitArrow) submitArrow.hidden = true;
      if (submitLoading) submitLoading.hidden = false;

      try {
        const payload = {
          name: form.querySelector('#field-name')?.value.trim(),
          email: form.querySelector('#field-email')?.value.trim(),
          phone: form.querySelector('#field-phone')?.value.trim() || undefined,
          company: form.querySelector('#field-company')?.value.trim() || undefined,
          service: form.querySelector('#field-service')?.value || undefined,
          pages: form.querySelector('#field-pages')?.value.trim() || undefined,
          message: form.querySelector('#field-message')?.value.trim(),
          attachments: uploadedFiles
            .filter(f => f.status === 'done' && f.key)
            .map(f => ({ name: f.name, key: f.key, size: f.size }))
        };

        const res = await fetch(`${API_URL}/contact`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('Send failed');

        // Success
        form.hidden = true;
        successEl.hidden = false;

      } catch (err) {
        console.error('Submit error:', err);
        errorEl.hidden = false;
      } finally {
        submitBtn.disabled = false;
        if (submitText) submitText.textContent = 'Wy≈õlij zapytanie';
        if (submitArrow) submitArrow.hidden = false;
        if (submitLoading) submitLoading.hidden = true;
      }
    });

    // Clear error on input
    form.querySelectorAll('.form__input').forEach(input => {
      input.addEventListener('input', () => {
        input.classList.remove('error');
        const errorEl = document.getElementById(`error-${input.name}`);
        if (errorEl) errorEl.textContent = '';
      });
    });
  }

  initContactForm();
  document.addEventListener('astro:after-swap', initContactForm);
</script>